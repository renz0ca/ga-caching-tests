name: Project1 Tests

on:
    push:
        branches: [main]
    pull_request:
    workflow_dispatch:
    
jobs:
    app_tests:
        runs-on: ubuntu-latest
        steps:

            # Configure Environment
            - name: Checkout repository
              uses: actions/checkout@v3
            - name: Install Python
              id: setup-python
              uses: actions/setup-python@v1
              with:
                python-version: 3.9
            - name: Install Poetry
              run: curl -sSL https://install.python-poetry.org | python3 -
            - name: Add Poetry to PATH
              run: echo "$HOME/.poetry/bin" >> $GITHUB_PATH
            
            # Prepare Virtual Environment
            - name: Configure Poetry
              run: poetry config virtualenvs.in-project true
            - name: Load cached virtual environment
              uses: actions/cache@v3
              id: cached-dependencies
              with:
                path: ./project1/.venv
                key: venv::${{ runner.os }}::${{ steps.setup-python.outputs.python-version }}::${{ hashFiles('./project1/poetry.lock') }}
            - name: Install dependencies
              if: steps.cached-dependencies.outputs.cache-hit != 'true'
              working-directory: ./project1
              run: poetry install --no-interaction --no-root
            - name: Install project
              working-directory: ./project1
              run: poetry install --no-interaction --only-root
            
            # Check Lint, Test, Security
            - name: Lint Project1
              working-directory: ./project1
              run: poetry run invoke lint
            - name: Test Project1
              working-directory: ./project1
              run: poetry run invoke test
            - name: Run Bandit security check
              working-directory: ./project1
              run: poetry run bandit -r ./test_project_1 -ll -ii
            - name: Safety vulnerability check
              working-directory: ./project1
              run: poetry export -f requirements.txt | poetry run safety check --full-report --stdin
